<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Gmail Chat Terminal</title>
    <!-- Load React and ReactDOM from a CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        /* Full-screen black terminal styling */
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .terminal {
            flex: 1;
            overflow-y: auto;
            padding: 1em;
        }
        .input-area {
            display: flex;
            border-top: 1px solid #333;
            padding: 0.5em;
        }
        .input-area input {
            flex: 1;
            background-color: #000;
            color: #fff;
            border: none;
            outline: none;
            padding: 0.5em;
            font-family: monospace;
            font-size: 1em;
        }
        .input-area button {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 0.5em 1em;
            margin-left: 0.5em;
            font-family: monospace;
            cursor: pointer;
        }
        .message {
            margin-bottom: 0.5em;
            white-space: pre-wrap;
        }
        .user-message::before {
            content: "> ";
            color: #0f0;
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function Terminal() {
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState("");
        const terminalEndRef = useRef(null);

        // Auto-scroll to the bottom whenever messages change
        useEffect(() => {
            if (terminalEndRef.current) {
                terminalEndRef.current.scrollIntoView({ behavior: "smooth" });
            }
        }, [messages]);

        const sendMessage = async () => {
            if (!input.trim()) return;
            const userMessage = input;
            // Append user's message to the conversation
            setMessages(prev => [...prev, { sender: "user", text: userMessage }]);
            setInput("");

            try {
                const response = await fetch("/stream", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: userMessage })
                });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let systemResponse = "";
                // Add an empty system message which will be updated as chunks arrive
                setMessages(prev => [...prev, { sender: "system", text: "" }]);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    systemResponse += chunk;
                    // Update the last system message with the latest response
                    setMessages(prev => {
                        const newMessages = [...prev];
                        newMessages[newMessages.length - 1].text = systemResponse;
                        return newMessages;
                    });
                }
            } catch (error) {
                console.error("Error fetching stream:", error);
            }
        };

        const handleKeyDown = (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        return (
            <div style={{ display: "flex", flexDirection: "column", height: "100vh" }}>
                <div className="terminal">
                    {messages.map((msg, index) => (
                        <div key={index} className={`message ${msg.sender === "user" ? "user-message" : ""}`}>
                            {msg.text}
                        </div>
                    ))}
                    <div ref={terminalEndRef} />
                </div>
                <div className="input-area">
                    <input
                        type="text"
                        placeholder="Type your message..."
                        value={input}
                        onChange={e => setInput(e.target.value)}
                        onKeyDown={handleKeyDown}
                    />
                    <button onClick={sendMessage}>Send</button>
                </div>
            </div>
        );
    }

    function App() {
        return <Terminal />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
<script>
    // On load, check if we’re authenticated – if not, redirect to login
    fetch('/check_auth')
        .then(res => res.json())
        .then(data => {
            if (!data.authenticated) {
                window.location.href = '/oauth/login';
            }
        })
        .catch(err => console.error("Error checking auth:", err));
</script>
</body>
</html>