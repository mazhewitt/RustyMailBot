<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Hello Chat App</title>
    <!-- Load React and ReactDOM from a CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
        }
        input {
            padding: 0.5em;
            font-size: 1em;
        }
        button {
            padding: 0.5em 1em;
            font-size: 1em;
            margin-left: 0.5em;
        }
        .response {
            margin-top: 1em;
            white-space: pre-wrap;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id="root"></div>

<!-- React App -->
<script type="text/babel">
    const { useState } = React;

    function App() {
        const [name, setName] = useState('');
        const [responseText, setResponseText] = useState('');

        const handleSubmit = async (e) => {
            e.preventDefault();
            setResponseText('');
            console.log("Submitting name:", name);
            try {
                const response = await fetch('/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name }),
                });
                console.log("Response status:", response.status);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let result = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    result += decoder.decode(value);
                    console.log("Received chunk:", decoder.decode(value));
                    setResponseText(result);
                }
            } catch (error) {
                console.error('Error during fetch:', error);
            }
        };

        // Submit the form when Enter is pressed (unless Shift is held).
        const handleKeyDown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSubmit(e);
            }
        };

        return (
            <div>
                <h1>Hello Chat App</h1>
                <form onSubmit={handleSubmit}>
                    <input
                        type="text"
                        placeholder="Enter your name"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        onKeyDown={handleKeyDown}
                    />
                    <button type="submit">Submit</button>
                </form>
                <div className="response">{responseText}</div>
            </div>
        );
    }

    // Render the App into the "root" element.
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>

<!-- On load, check if we’re authenticated – if not, redirect to login -->
<script>
    fetch('/check_auth')
        .then(res => res.json())
        .then(data => {
            if (!data.authenticated) {
                // Not yet authenticated, so go to our OAuth login endpoint.
                window.location.href = '/oauth/login';
            }
        })
        .catch(err => console.error("Error checking auth:", err));
</script>
</body>
</html>